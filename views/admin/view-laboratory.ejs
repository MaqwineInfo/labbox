<!DOCTYPE html>
<html lang="en" dir="ltr" data-startbar="dark" data-bs-theme="light">

<head>
    <%- include('../partials/head') %>
</head>

<body>

    <%- include('../partials/topbar') %>
    <%- include('../partials/sidebar') %>

    <div class="page-wrapper">
        <div class="page-content">
            <div class="container-fluid">

                <!-- Page Title -->
                <div class="row">
                    <div class="col-sm-12">
                        <div class="page-title-box d-md-flex justify-content-md-between align-items-center">
                            <h4 class="page-title">
                                <%= lab.name ? lab.name + ' Laboratory' : 'Laboratory Details' %>
                            </h4>
                            <a href="/admin/laboratory" class="btn btn-sm btn-outline-secondary">Back to
                                List</a>
                        </div>
                    </div>
                </div>

                <!-- Error/Success Messages -->
                <div class="row">
                    <div class="col-12">
                        <% if (typeof error !=='undefined' && error) { %>
                        <div class="alert alert-danger">
                            <%= error %>
                        </div>
                        <% } %>
                        <% if (typeof success !=='undefined' && success) { %>
                        <div class="alert alert-success">
                            <%= success %>
                        </div>
                        <% } %>
                    </div>
                </div>

                <!-- Laboratory Details Card -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Detailing List</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <dl class="row mb-0">
                                            <dt class="col-sm-4">Logo</dt>
                                            <dd class="col-sm-8">
                                                <img src="<%= lab.logo || 'https://placehold.co/50x50/eee/31343c?text=Logo' %>"
                                                    style="border-radius:50%" width="50px" height="50px" alt="">
                                            </dd>
                                            <dt class="col-sm-4">Laboratory Name</dt>
                                            <dd class="col-sm-8">
                                                <%= lab.name %>
                                            </dd>
                                            <dt class="col-sm-4">Owner Name</dt>
                                            <dd class="col-sm-8">
                                                <%= lab.owner %>
                                            </dd>
                                            <dt class="col-sm-4">Contact No.1</dt>
                                            <dd class="col-sm-8">
                                                <%= lab.contact_1 %>
                                            </dd>
                                            <dt class="col-sm-4">Contact No.2</dt>
                                            <dd class="col-sm-8">
                                                <%= lab.contact_2 || '--' %>
                                            </dd>
                                        </dl>
                                    </div>
                                    <div class="col-md-6">
                                        <dl class="row mb-0">
                                            <dt class="col-sm-4">Email</dt>
                                            <dd class="col-sm-8">
                                                <%= lab.email %>
                                            </dd>
                                            <dt class="col-sm-4">Address(Current)</dt>
                                            <dd class="col-sm-8">
                                                <%= lab.address_1 %>
                                            </dd>
                                            <dt class="col-sm-4">Address(Optional)</dt>
                                            <dd class="col-sm-8">
                                                <%= lab.address_2 || '--' %>
                                            </dd>
                                            <dt class="col-sm-4">City</dt>
                                            <dd class="col-sm-8">
                                                <%= lab.city %>
                                            </dd>
                                            <dt class="col-sm-4">State</dt>
                                            <dd class="col-sm-8">
                                                <%= lab.state %>
                                            </dd>
                                            <dt class="col-sm-4">Zipcode</dt>
                                            <dd class="col-sm-8">
                                                <%= lab.zipcode %>
                                            </dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Categories and Packages Tables -->
                <div class="row">
                    <!-- Categories -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Categories</h6>
                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal"
                                    data-bs-target="#addCategoryModal">
                                    Add Category
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Category</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% if (labCategories && labCategories.length> 0) { %>
                                            <% labCategories.forEach(lc=> { %>
                                            <% if (lc.category_id) { %> <!-- Check if category_id exists (not deleted) -->
                                            <tr>
                                                <td>
                                                    <%= lc.category_id.name %>
                                                </td>
                                                <td>
                                                    <a href="#" class="text-danger delete-btn"
                                                        data-id="<%= lc._id %>" data-type="category">
                                                        <i class="iconoir-trash"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                            <% } %>
                                            <% }); %>
                                            <% } else { %>
                                            <tr>
                                                <td colspan="2" class="text-center">No
                                                    categories assigned.</td>
                                            </tr>
                                            <% } %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Packages -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Packages</h6>
                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal"
                                    data-bs-target="#addPackageModal">
                                    Add Package
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Package</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% if (labPackages && labPackages.length> 0) { %>
                                            <% labPackages.forEach(lp=> { %>
                                            <% if (lp.package_id) { %> <!-- Check if package_id exists (not deleted) -->
                                            <tr>
                                                <td>
                                                    <%= lp.package_id.name %>
                                                </td>
                                                <td>
                                                    <a href="#" class="text-danger delete-btn"
                                                        data-id="<%= lp._id %>" data-type="package">
                                                        <i class="iconoir-trash"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                            <% } %>
                                            <% }); %>
                                            <% } else { %>
                                            <tr>
                                                <td colspan="2" class="text-center">No packages
                                                    assigned.</td>
                                            </tr>
                                            <% } %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div> <!-- container-fluid -->

            <!-- Appearance Offcanvas -->
            <div class="offcanvas offcanvas-end" tabindex="-1" id="Appearance"
                aria-labelledby="AppearanceLabel">
                <div class="offcanvas-header border-bottom justify-content-between">
                    <h5 class="m-0 font-14" id="AppearanceLabel">Appearance</h5>
                    <button type="button" class="btn-close text-reset p-0 m-0 align-self-center"
                        data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body"></div>
            </div>

        </div>
        <!-- end page content -->
    </div>
    <!-- end page-wrapper -->

    <!-- Add Category Modal -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCategoryModalLabel">Add Category to Laboratory</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <hr class="m-0">
                <form id="addCategoryForm" method="POST" action="/admin/laboratory/add-category">
                    <div class="modal-body">
                        <input type="hidden" name="laboratory_id" value="<%= lab._id %>">

                        <div class="mb-3">
                            <label for="category_id" class="form-label">Category</label>
                            <select class="form-control" name="category_id" id="category_id" required>
                                <option value="" hidden>Select Category</option>
                                
                                <!-- SUDHARO: Ahiya 'availableCategories' vapro -->
                                <% if (typeof availableCategories !=='undefined' && availableCategories.length> 0) { %>
                                    <% availableCategories.forEach(cat=> { %>
                                <option value="<%= cat._id %>">
                                    <%= cat.name %>
                                </option>
                                <% }); %>
                                <% } else { %>
                                <option value="" disabled>No categories available (or all added)
                                </option>
                                <% } %>

                            </select>
                        </div>
                    </div>

                    <hr class="m-0">
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Package Modal -->
    <div class="modal fade" id="addPackageModal" tabindex="-1" aria-labelledby="addPackageModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPackageModalLabel">Add Package to Laboratory</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <hr class="m-0">
                <form id="addPackageForm" method="POST" action="/admin/laboratory/add-package">
                    <div class="modal-body">
                        <input type="hidden" name="laboratory_id" value="<%= lab._id %>">

                        <div class="mb-3">
                            <label for="modal_category_id" class="form-label">Category</label>
                            <!-- SUDHARO: Ahiya 'allCategories' vapro (aa barabar chhe) -->
                            <select class="form-control" name="category_id" id="modal_category_id" required>
                                <option value="" hidden>Select category</option>
                                <% if (typeof allCategories !=='undefined' && allCategories.length> 0) { %>
                                <% allCategories.forEach(cat=> { %>
                                <option value="<%= cat._id %>">
                                    <%= cat.name %>
                                </option>
                                <% }); %>
                                <% } %>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="package-dropdown" class="form-label">Package</label>
                            <select id="package-dropdown" name="package_id" class="form-control" required>
                                <option value="" hidden>Select Category First</option>
                            </select>
                        </div>
                    </div>
                    <hr class="m-0">
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <h5 class="modal-title justify-content-center" id="deleteModalLabel">
                        <i class="iconoir-warning-circle-outline" style="font-size: 3rem; color: #f1416c;"></i>
                    </h5><br>
                    <h6 id="confirmationMessage">Are you sure?</h6>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">OK</button>
                </div>
            </div>
        </div>
    </div>

    <%- include('../partials/scripts') %>

    <!-- Page Specific Scripts -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // SUDHARO: Token variable banavo
            const authToken = 'Bearer ' + localStorage.getItem('authToken');

            // 1. Handle Delete Confirmation Modal (for categories/packages)
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            const confirmDeleteBtn = document.getElementById('confirmDelete');
            const confirmationMessage = document.getElementById('confirmationMessage');
            let deleteUrl = '';

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    const id = this.getAttribute('data-id');
                    const type = this.getAttribute('data-type');

                    if (type === 'category') {
                        confirmationMessage.innerText = 'Are you sure you want to delete this category from the laboratory?';
                        deleteUrl = `/admin/laboratory/delete-category/${id}`;
                    } else if (type === 'package') {
                        confirmationMessage.innerText = 'Are you sure you want to delete this package from the laboratory?';
                        deleteUrl = `/admin/laboratory/delete-package/${id}`;
                    }

                    deleteModal.show();
                });
            });

            // Handle the confirmation click
            confirmDeleteBtn.addEventListener('click', async function () {
                if (deleteUrl) {
                    try {
                        const response = await fetch(deleteUrl, { 
                            method: 'DELETE',
                            headers: {
                                'Authorization': authToken // SUDHARO: Token add karyu
                            }
                        });
                        if (response.ok) {
                            deleteModal.hide();
                            location.reload();
                        } else {
                            const err = await response.json();
                            alert(err.message || 'Failed to delete.');
                        }
                    } catch (error) {
                        alert('An error occurred.');
                    }
                }
            });
 
            const categorySelect = document.getElementById('modal_category_id');
            const packageSelect = document.getElementById('package-dropdown');

            categorySelect.addEventListener('change', async function () {
                const categoryId = this.value;
                const laboratoryId = '<%= lab._id %>'; 

                if (!categoryId) {
                    packageSelect.innerHTML = '<option value="">Select Category First</option>';
                    return;
                }
                
                packageSelect.innerHTML = '<option value="">Loading...</option>';

                try {
                    // SUDHARO: Fetch call ma Authorization header add karyu
                    const response = await fetch(`/admin/packages/by-category/${categoryId}/not-in-lab/${laboratoryId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': authToken
                        }
                    });

                    if (!response.ok) throw new Error('Failed to fetch');

                    const packages = await response.json();

                    packageSelect.innerHTML = '<option value="">Select Package</option>';
                    if (packages.length > 0) {
                        packages.forEach(pkg => {
                            packageSelect.innerHTML += `<option value="${pkg._id}">${pkg.name}</option>`;
                        });
                    } else {
                        packageSelect.innerHTML = '<option value="" disabled>No available packages in this category</option>';
                    }
                } catch (error) {
                    console.error('Failed to fetch packages:', error);
                    packageSelect.innerHTML = '<option value="" disabled>Error loading packages</option>';
                }
            });
 
            handleFormSubmit('addCategoryForm');
            handleFormSubmit('addPackageForm');

            function handleFormSubmit(formId) {
                const form = document.getElementById(formId);
                form.addEventListener('submit', async function (event) {
                    event.preventDefault();
                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData.entries());

                    try { 
                        const response = await fetch(form.action, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Authorization': authToken
                            },
                            body: JSON.stringify(data)
                        });

                        if (response.ok) {
                            location.reload();
                        } else {
                            const err = await response.json();
                            alert(err.message || 'Failed to add item.');
                        }
                    } catch (error) {
                        alert('An error occurred.');
                    }
                });
            }
        });
    </script>

</body>

</html>