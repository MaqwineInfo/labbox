<!DOCTYPE html>
<html lang="en" dir="ltr" data-startbar="dark" data-bs-theme="light">

<head>
    <%- include('../partials/head') %>
</head>

<body>
    <%- include('../partials/topbar') %>
        <%- include('../partials/sidebar') %>

            <div class="page-wrapper">
                <div class="page-content">
                    <div class="container-fluid">

                        <div class="row">
                            <div class="col-sm-12">
                                <div class="page-title-box d-md-flex justify-content-md-between align-items-center">
                                    <h4 class="page-title">
                                        Permission Box for <%= user ? user.email : 'User' %>
                                    </h4>
                                    <a href="/admin/users" class="btn btn-sm btn-outline-secondary">Back to User
                                        List</a>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="card-title">Set Permissions</h4>
                                    </div>
                                    <div class="card-body">
                                        <form id="addPermissionForm" method="POST"
                                            action="/admin/users/<%= user._id %>/permissions">
                                            <div class="modal-body">
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>Pages</th>
                                                                <th>Create</th>
                                                                <th>Read</th>
                                                                <th>Update</th>
                                                                <th>Delete</th>
                                                                <th>All</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <%# Patient Permissions %>
                                                                <tr>
                                                                    <td>Patient</td>
                                                                    <td>--</td>
                                                                    <td><input type="checkbox" name="patient_read"
                                                                            class="patient-checkbox" value='1'
                                                                            <%=(permission.patient_read) ? 'checked'
                                                                            : '' %>></td>
                                                                    <td>--</td>
                                                                    <td><input type="checkbox" name="patient_delete"
                                                                            class="patient-checkbox" value='1'
                                                                            <%=(permission.patient_delete) ? 'checked'
                                                                            : '' %>></td>
                                                                    <td><input type="checkbox" id="patient_all"
                                                                            onclick="toggleCheckboxes('patient-checkbox', this.checked)"
                                                                            <%=(permission.patient_read &&
                                                                            permission.patient_delete) ? 'checked' : ''
                                                                            %>></td>
                                                                </tr>
                                                                <%# Laboratory Permissions %>
                                                                    <tr>
                                                                        <td>Laboratory</td>
                                                                        <td><input type="checkbox" name="lab_add"
                                                                                class="lab-checkbox" value='1'
                                                                                <%=(permission.lab_add) ? 'checked' : ''
                                                                                %>></td>
                                                                        <td><input type="checkbox" name="lab_read"
                                                                                class="lab-checkbox" value='1'
                                                                                <%=(permission.lab_read) ? 'checked'
                                                                                : '' %>></td>
                                                                        <td><input type="checkbox" name="lab_update"
                                                                                class="lab-checkbox" value='1'
                                                                                <%=(permission.lab_update) ? 'checked'
                                                                                : '' %>></td>
                                                                        <td><input type="checkbox" name="lab_delete"
                                                                                class="lab-checkbox" value='1'
                                                                                <%=(permission.lab_delete) ? 'checked'
                                                                                : '' %>></td>
                                                                        <td><input type="checkbox" id="lab_all"
                                                                                onclick="toggleCheckboxes('lab-checkbox', this.checked)"
                                                                                <%=(permission.lab_add &&
                                                                                permission.lab_read &&
                                                                                permission.lab_update &&
                                                                                permission.lab_delete) ? 'checked' : ''
                                                                                %>></td>
                                                                    </tr>
                                                                    <%# Categories Permissions %>
                                                                        <tr>
                                                                            <td>Categories</td>
                                                                            <td><input type="checkbox" name="cate_add"
                                                                                    class="cate-checkbox" value='1'
                                                                                    <%=(permission.cate_add) ? 'checked'
                                                                                    : '' %>></td>
                                                                            <td><input type="checkbox" name="cate_read"
                                                                                    class="cate-checkbox" value='1'
                                                                                    <%=(permission.cate_read)
                                                                                    ? 'checked' : '' %>></td>
                                                                            <td><input type="checkbox"
                                                                                    name="cate_update"
                                                                                    class="cate-checkbox" value='1'
                                                                                    <%=(permission.cate_update)
                                                                                    ? 'checked' : '' %>></td>
                                                                            <td><input type="checkbox"
                                                                                    name="cate_delete"
                                                                                    class="cate-checkbox" value='1'
                                                                                    <%=(permission.cate_delete)
                                                                                    ? 'checked' : '' %>></td>
                                                                            <td><input type="checkbox" id="cate_all"
                                                                                    onclick="toggleCheckboxes('cate-checkbox', this.checked)"
                                                                                    <%=(permission.cate_add &&
                                                                                    permission.cate_read &&
                                                                                    permission.cate_update &&
                                                                                    permission.cate_delete) ? 'checked'
                                                                                    : '' %>></td>
                                                                        </tr>
                                                                        <%# Packages Permissions %>
                                                                            <tr>
                                                                                <td>Packages</td>
                                                                                <td><input type="checkbox"
                                                                                        name="pack_add"
                                                                                        class="pack-checkbox" value='1'
                                                                                        <%=(permission.pack_add)
                                                                                        ? 'checked' : '' %>></td>
                                                                                <td><input type="checkbox"
                                                                                        name="pack_read"
                                                                                        class="pack-checkbox" value='1'
                                                                                        <%=(permission.pack_read)
                                                                                        ? 'checked' : '' %>></td>
                                                                                <td><input type="checkbox"
                                                                                        name="pack_update"
                                                                                        class="pack-checkbox" value='1'
                                                                                        <%=(permission.pack_update)
                                                                                        ? 'checked' : '' %>></td>
                                                                                <td><input type="checkbox"
                                                                                        name="pack_delete"
                                                                                        class="pack-checkbox" value='1'
                                                                                        <%=(permission.pack_delete)
                                                                                        ? 'checked' : '' %>></td>
                                                                                <td><input type="checkbox" id="pack_all"
                                                                                        onclick="toggleCheckboxes('pack-checkbox', this.checked)"
                                                                                        <%=(permission.pack_add &&
                                                                                        permission.pack_read &&
                                                                                        permission.pack_update &&
                                                                                        permission.pack_delete)
                                                                                        ? 'checked' : '' %>></td>
                                                                            </tr>
                                                                            <%# Sub-packages Permissions %>
                                                                                <tr>
                                                                                    <td>Sub-packages</td>
                                                                                    <td><input type="checkbox"
                                                                                            name="sub_add"
                                                                                            class="sub-checkbox"
                                                                                            value='1'
                                                                                            <%=(permission.sub_add)
                                                                                            ? 'checked' : '' %>>
                                                                                    </td>
                                                                                    <td><input type="checkbox"
                                                                                            name="sub_read"
                                                                                            class="sub-checkbox"
                                                                                            value='1'
                                                                                            <%=(permission.sub_read)
                                                                                            ? 'checked' : '' %>>
                                                                                    </td>
                                                                                    <td><input type="checkbox"
                                                                                            name="sub_update"
                                                                                            class="sub-checkbox"
                                                                                            value='1'
                                                                                            <%=(permission.sub_update)
                                                                                            ? 'checked' : '' %>>
                                                                                    </td>
                                                                                    <td><input type="checkbox"
                                                                                            name="sub_delete"
                                                                                            class="sub-checkbox"
                                                                                            value='1'
                                                                                            <%=(permission.sub_delete)
                                                                                            ? 'checked' : '' %>>
                                                                                    </td>
                                                                                    <td><input type="checkbox"
                                                                                            id="sub_all"
                                                                                            onclick="toggleCheckboxes('sub-checkbox', this.checked)"
                                                                                            <%=(permission.sub_add &&
                                                                                            permission.sub_read &&
                                                                                            permission.sub_update &&
                                                                                            permission.sub_delete)
                                                                                            ? 'checked' : '' %>>
                                                                                    </td>
                                                                                </tr>
                                                                                <%# Banner Permissions %>
                                                                                    <tr>
                                                                                        <td>Banner</td>
                                                                                        <td><input type="checkbox"
                                                                                                name="banner_add"
                                                                                                class="banner-checkbox"
                                                                                                value='1'
                                                                                                <%=(permission.banner_add)
                                                                                                ? 'checked' : '' %>>
                                                                                        </td>
                                                                                        <td><input type="checkbox"
                                                                                                name="banner_read"
                                                                                                class="banner-checkbox"
                                                                                                value='1'
                                                                                                <%=(permission.banner_read)
                                                                                                ? 'checked' : '' %>>
                                                                                        </td>
                                                                                        <td><input type="checkbox"
                                                                                                name="banner_update"
                                                                                                class="banner-checkbox"
                                                                                                value='1'
                                                                                                <%=(permission.banner_update)
                                                                                                ? 'checked' : '' %>>
                                                                                        </td>
                                                                                        <td><input type="checkbox"
                                                                                                name="banner_delete"
                                                                                                class="banner-checkbox"
                                                                                                value='1'
                                                                                                <%=(permission.banner_delete)
                                                                                                ? 'checked' : '' %>>
                                                                                        </td>
                                                                                        <td><input type="checkbox"
                                                                                                id="banner_all"
                                                                                                onclick="toggleCheckboxes('banner-checkbox', this.checked)"
                                                                                                <%=(permission.banner_add
                                                                                                &&
                                                                                                permission.banner_read
                                                                                                &&
                                                                                                permission.banner_update
                                                                                                &&
                                                                                                permission.banner_delete)
                                                                                                ? 'checked' : '' %>>
                                                                                        </td>
                                                                                    </tr>
                                                                                    <%# Offers Permissions %>
                                                                                        <tr>
                                                                                            <td>Offers</td>
                                                                                            <td><input type="checkbox"
                                                                                                    name="offer_add"
                                                                                                    class="offer-checkbox"
                                                                                                    value='1'
                                                                                                    <%=(permission.offer_add)
                                                                                                    ? 'checked' : '' %>>
                                                                                            </td>
                                                                                            <td><input type="checkbox"
                                                                                                    name="offer_read"
                                                                                                    class="offer-checkbox"
                                                                                                    value='1'
                                                                                                    <%=(permission.offer_read)
                                                                                                    ? 'checked' : '' %>>
                                                                                            </td>
                                                                                            <td><input type="checkbox"
                                                                                                    name="offer_update"
                                                                                                    class="offer-checkbox"
                                                                                                    value='1'
                                                                                                    <%=(permission.offer_update)
                                                                                                    ? 'checked' : '' %>>
                                                                                            </td>
                                                                                            <td><input type="checkbox"
                                                                                                    name="offer_delete"
                                                                                                    class="offer-checkbox"
                                                                                                    value='1'
                                                                                                    <%=(permission.offer_delete)
                                                                                                    ? 'checked' : '' %>>
                                                                                            </td>
                                                                                            <td><input type="checkbox"
                                                                                                    id="offer_all"
                                                                                                    onclick="toggleCheckboxes('offer-checkbox', this.checked)"
                                                                                                    <%=(permission.offer_add
                                                                                                    &&
                                                                                                    permission.offer_read
                                                                                                    &&
                                                                                                    permission.offer_update
                                                                                                    &&
                                                                                                    permission.offer_delete)
                                                                                                    ? 'checked' : '' %>>
                                                                                            </td>
                                                                                        </tr>
                                                                                        <%# Orders Permissions %>
                                                                                            <tr>
                                                                                                <td>Orders</td>
                                                                                                <td>--</td>
                                                                                                <td><input
                                                                                                        type="checkbox"
                                                                                                        name="order_read"
                                                                                                        class="order-checkbox"
                                                                                                        value='1'
                                                                                                        <%=(permission.order_read)
                                                                                                        ? 'checked' : ''
                                                                                                        %>>
                                                                                                </td>
                                                                                                <td><input
                                                                                                        type="checkbox"
                                                                                                        name="order_update"
                                                                                                        class="order-checkbox"
                                                                                                        value='1'
                                                                                                        <%=(permission.order_update)
                                                                                                        ? 'checked' : ''
                                                                                                        %>>
                                                                                                </td>
                                                                                                <td>--</td>
                                                                                                <td><input
                                                                                                        type="checkbox"
                                                                                                        id="order_all"
                                                                                                        onclick="toggleCheckboxes('order-checkbox', this.checked)"
                                                                                                        <%=(permission.order_read
                                                                                                        &&
                                                                                                        permission.order_update)
                                                                                                        ? 'checked' : ''
                                                                                                        %>>
                                                                                                </td>
                                                                                            </tr>
                                                                                            <%# Reports Permissions %>
                                                                                                <tr>
                                                                                                    <td>Reports</td>
                                                                                                    <td>--</td>
                                                                                                    <td><input
                                                                                                            type="checkbox"
                                                                                                            name="report_read"
                                                                                                            class="report-checkbox"
                                                                                                            value='1'
                                                                                                            <%=(permission.report_read)
                                                                                                            ? 'checked'
                                                                                                            : '' %>>
                                                                                                    </td>
                                                                                                    <td><input
                                                                                                            type="checkbox"
                                                                                                            name="report_update"
                                                                                                            class="report-checkbox"
                                                                                                            value='1'
                                                                                                            <%=(permission.report_update)
                                                                                                            ? 'checked'
                                                                                                            : '' %>>
                                                                                                    </td>
                                                                                                    <td><input
                                                                                                            type="checkbox"
                                                                                                            name="report_delete"
                                                                                                            class="report-checkbox"
                                                                                                            value='1'
                                                                                                            <%=(permission.report_delete)
                                                                                                            ? 'checked'
                                                                                                            : '' %>>
                                                                                                    </td>
                                                                                                    <td><input
                                                                                                            type="checkbox"
                                                                                                            id="report_all"
                                                                                                            onclick="toggleCheckboxes('report-checkbox', this.checked)"
                                                                                                            <%=(permission.report_read
                                                                                                            &&
                                                                                                            permission.report_update
                                                                                                            &&
                                                                                                            permission.report_delete)
                                                                                                            ? 'checked'
                                                                                                            : '' %>>
                                                                                                    </td>
                                                                                                </tr>
                                                                                                <%# Doctor Permissions
                                                                                                    %>
                                                                                                    <tr>
                                                                                                        <td>Doctor
                                                                                                        </td>
                                                                                                        <td><input
                                                                                                                type="checkbox"
                                                                                                                name="doctor_add"
                                                                                                                class="doctor-checkbox"
                                                                                                                value='1'
                                                                                                                <%=(permission.doctor_add)
                                                                                                                ? 'checked'
                                                                                                                : '' %>>
                                                                                                        </td>
                                                                                                        <td><input
                                                                                                                type="checkbox"
                                                                                                                name="doctor_read"
                                                                                                                class="doctor-checkbox"
                                                                                                                value='1'
                                                                                                                <%=(permission.doctor_read)
                                                                                                                ? 'checked'
                                                                                                                : '' %>>
                                                                                                        </td>
                                                                                                        <td><input
                                                                                                                type="checkbox"
                                                                                                                name="doctor_update"
                                                                                                                class="doctor-checkbox"
                                                                                                                value='1'
                                                                                                                <%=(permission.doctor_update)
                                                                                                                ? 'checked'
                                                                                                                : '' %>>
                                                                                                        </td>
                                                                                                        <td><input
                                                                                                                type="checkbox"
                                                                                                                name="doctor_delete"
                                                                                                                class="doctor-checkbox"
                                                                                                                value='1'
                                                                                                                <%=(permission.doctor_delete)
                                                                                                                ? 'checked'
                                                                                                                : '' %>>
                                                                                                        </td>
                                                                                                        <td><input
                                                                                                                type="checkbox"
                                                                                                                id="doctor_all"
                                                                                                                onclick="toggleCheckboxes('doctor-checkbox', this.checked)"
                                                                                                                <%=(permission.doctor_add
                                                                                                                &&
                                                                                                                permission.doctor_read
                                                                                                                &&
                                                                                                                permission.doctor_update
                                                                                                                &&
                                                                                                                permission.doctor_delete)
                                                                                                                ? 'checked'
                                                                                                                : '' %>>
                                                                                                        </td>
                                                                                                    </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <hr class="m-0">
                                            <div class="card-footer text-end">
                                                <button type="submit" class="btn btn-primary">Save
                                                    Permissions</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="offcanvas offcanvas-end" tabindex="-1" id="Appearance"
                        aria-labelledby="AppearanceLabel">
                        <div class="offcanvas-header border-bottom justify-content-between">
                            <h5 class="m-0 font-14" id="AppearanceLabel">Appearance</h5>
                            <button type="button" class="btn-close text-reset p-0 m-0 align-self-center"
                                data-bs-dismiss="offcanvas" aria-label="Close"></button>
                        </div>
                        <div class="offcanvas-body"></div>
                    </div>

                </div>
            </div>

            <%- include('../partials/scripts') %>

                <script>
                    function toggleCheckboxes(className, isChecked) {
                        document.querySelectorAll(`input.${className}`).forEach(checkbox => {
                            checkbox.checked = isChecked;
                        });
                    }

                    document.addEventListener('DOMContentLoaded', function () {
                        const form = document.getElementById('addPermissionForm');
                        const adminToken = localStorage.getItem('adminToken');
                        const authToken = 'Bearer ' + adminToken;

                        if (!adminToken) {
                            alert('Authentication token is missing. Please log in again.');
                            window.location.href = '/admin';
                            return;
                        }

                        form.addEventListener('submit', async function (e) {
                            e.preventDefault();
                            const submitButton = form.querySelector('button[type="submit"]');
                            submitButton.disabled = true;

                            const formData = new FormData(form);
                            const data = {};
                            for (const pair of formData.entries()) {
                                if (pair[1] === '1') {
                                    data[pair[0]] = 1;
                                }
                            }
                            try {
                                const response = await fetch(form.action, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': authToken
                                    },
                                    body: JSON.stringify(data)
                                });

                                const result = await response.json();

                                if (response.ok && result.status === true) {
                                    alert(result.message || 'Permissions saved!');
                                    window.location.href = result.redirectUrl || '/admin/users';
                                } else {
                                    if (response.status === 401 || response.status === 403) {
                                        alert('Session expired or unauthorized. Please log in again.');
                                        window.location.href = '/admin';
                                    } else {
                                        alert(result.message || `Failed to save permissions. Server Response Status: ${response.status}`);
                                    }
                                }
                            } catch (error) {
                                alert('A network error occurred. Please check your browser console and server logs.');
                                console.error("AJAX Error:", error);
                            } finally {
                                submitButton.disabled = false;
                            }
                        });
                        document.querySelectorAll('.table-responsive input[type="checkbox"]').forEach(checkbox => {
                            const isAllBox = checkbox.id.endsWith('_all');
                            if (!isAllBox) {
                                checkbox.addEventListener('change', function () {
                                    const className = this.className;
                                    const allId = className.replace('-checkbox', '_all');
                                    const allBox = document.getElementById(allId);

                                    if (allBox && !this.checked) {
                                        allBox.checked = false;
                                    }
                                });
                            }
                        });
                    });
                </script>

</body>

</html>