<!DOCTYPE html>
<html lang="en" dir="ltr" data-startbar="dark" data-bs-theme="light">

<head>
    <%- include('../partials/head') %>
</head>

<body>

    <%- include('../partials/topbar') %>
    <%- include('../partials/sidebar') %>

    <div class="page-wrapper">
        <div class="page-content">
            <div class="container-fluid">

                <!-- Page Title & Add Button -->
                <div class="row">
                    <div class="col-sm-12">
                        <div class="page-title-box d-md-flex justify-content-md-between align-items-center">
                            <h4 class="page-title">Offers</h4>
                            <%# Add permission check if needed %>
                            <button type="button" class="btn btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#addOfferModal">
                                Add Offer
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Error/Success Messages -->
                <div class="row">
                    <div class="col-12">
                        <% if (typeof error !== 'undefined' && error) { %>
                            <div class="alert alert-danger"><%= error %></div>
                        <% } %>
                        <% if (typeof success !== 'undefined' && success) { %>
                            <div class="alert alert-success"><%= success %></div>
                        <% } %>
                    </div>
                </div>

                <!-- Offer Table -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Offer List</h4>
                            </div>
                            <div class="card-body">
                                
                                <!-- Filters and Search -->
                                <div class="d-flex flex-wrap justify-content-between mb-3">
                                    <form class="d-flex" id="searchForm" action="/admin/offers" method="GET">
                                        <input class="form-control me-2" type="search" placeholder="Search by Link" name="linked_with" value="<%= typeof query !== 'undefined' ? query.linked_with : '' %>">
                                        <button class="btn btn-outline-primary" type="submit">Search</button>
                                        <a href="/admin/offers" class="btn btn-outline-secondary ms-2">Clear</a>
                                    </form>
                                    
                                    <div class="ms-auto">
                                        <div class="dropdown">
                                            <button class="btn btn-primary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                                Filter
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="filterDropdown">
                                                <li><a class="dropdown-item" href="/admin/offers?status=all">All</a></li>
                                                <li><a class="dropdown-item" href="/admin/offers?status=1">Active</a></li>
                                                <li><a class="dropdown-item" href="/admin/offers?status=0">Inactive</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Table -->
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="offerTable">
                                        <thead>
                                            <tr>
                                                <th>Image</th>
                                                <th>Linked with</th>
                                                <th>From</th>
                                                <th>To</th>
                                                <th>Status</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% if (typeof offer !== 'undefined' && offer.length > 0) { %>
                                                <% offer.forEach(b => { %>
                                                    <tr>
                                                        <td>
                                                            <img src="<%= b.avatar || 'https://placehold.co/50x50/eee/31343c?text=Img' %>" style="border-radius:50%" width="50px" height="50px" alt="Offer">
                                                        </td>
                                                        <td><a href="<%= b.linked_with %>" target="_blank"><%= b.linked_with %></a></td>
                                                        <td><%= b.from ? new Date(b.from).toLocaleDateString('en-CA') : 'N/A' %></td>
                                                        <td><%= b.to ? new Date(b.to).toLocaleDateString('en-CA') : 'N/A' %></td>
                                                        <td>
                                                            <% if (b.status == 1) { %>
                                                                <span class="badge bg-success-subtle text-success">Active</span>
                                                            <% } else { %>
                                                                <span class="badge bg-danger-subtle text-danger">Inactive</span>
                                                            <% } %>
                                                        </td>
                                                        <td>
                                                            <div class="dropdown">
                                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle edit-Offer-link" type="button" data-bs-toggle="dropdown" aria-expanded="false"
                                                                    data-id="<%= b._id %>"
                                                                    data-avatar="<%= b.avatar %>"
                                                                    data-linked_with="<%= b.linked_with %>"
                                                                    data-from="<%= b.from ? new Date(b.from).toLocaleDateString('en-CA') : '' %>"
                                                                    data-to="<%= b.to ? new Date(b.to).toLocaleDateString('en-CA') : '' %>">
                                                                    Action
                                                                </button>
                                                                <ul class="dropdown-menu">
                                                                    <li>
                                                                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editOfferModal">
                                                                            Edit
                                                                        </a>
                                                                    </li>
                                                                    <li>
                                                                        <% if(b.status == 1) { %>
                                                                            <a class="dropdown-item action-btn" href="#" data-id="<%= b._id %>" data-action="inactive">Inactive</a>
                                                                        <% } else { %>
                                                                            <a class="dropdown-item action-btn" href="#" data-id="<%= b._id %>" data-action="active">Active</a>
                                                                        <% } %>
                                                                    </li>
                                                                    <li><hr class="dropdown-divider"></li>
                                                                    <li>
                                                                        <a class="dropdown-item text-danger action-btn" href="#" data-id="<%= b._id %>" data-action="delete">Delete</a>
                                                                    </li>
                                                                </ul>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                <% }); %>
                                            <% } else { %>
                                                <tr>
                                                    <td colspan="6" class="text-center">No offers found.</td>
                                                </tr>
                                            <% } %>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- Pagination (Add if needed) -->
                            </div>
                        </div>
                    </div>
                </div>

            </div> <!-- container-fluid -->

            <!-- Appearance Offcanvas -->
            <div class="offcanvas offcanvas-end" tabindex="-1" id="Appearance" aria-labelledby="AppearanceLabel">
                <div class="offcanvas-header border-bottom justify-content-between">
                    <h5 class="m-0 font-14" id="AppearanceLabel">Appearance</h5>
                    <button type="button" class="btn-close text-reset p-0 m-0 align-self-center" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body"></div>
            </div>

        </div>
        <!-- end page content -->
    </div>
    <!-- end page-wrapper -->

    <!-- Add Offer Modal -->
    <div class="modal fade" id="addOfferModal" tabindex="-1" aria-labelledby="addOfferModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addOfferModalLabel">Add Offer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <hr class="m-0">
                <form id="addOfferForm" method="POST" action="/admin/offers/add" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="OfferImage" class="form-label">Offer Image</label>
                            <input type="file" class="form-control" id="OfferImage" name="avatar">
                        </div>
                        <div class="mb-3">
                            <label for="Link" class="form-label">Linked With</label>
                            <textarea class="form-control" id="Link" name="linked_with" placeholder="Link with?"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="from" class="form-label">From</label>
                            <input type="date" class="form-control" id="from" name="from" required>
                        </div>
                        <div class="mb-3">
                            <label for="to" class="form-label">To</label>
                            <input type="date" class="form-control" id="to" name="to" required>
                        </div>
                    </div>
                    <hr class="m-0">
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Offer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Offer Modal -->
    <div class="modal fade" id="editOfferModal" tabindex="-1" aria-labelledby="editOfferModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editOfferModalLabel">Edit Offer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <hr class="m-0">
                <form id="editOfferForm" method="POST" enctype="multipart/form-data">
                    <input type="hidden" id="editOfferId" name="id">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editOfferImage" class="form-label">Offer Image</label>
                            <input type="file" class="form-control" id="editOfferImage" name="avatar">
                            <div class="mt-2">
                                <img id="editOfferImagePreview" src="" alt="Offer Image" style="height: 100px; width: 100px; border-radius:50%; display: none;">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editLink" class="form-label">Linked With</label>
                            <textarea class="form-control" id="editLink" name="linked_with"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editfrom" class="form-label">From</label>
                            <input type="date" class="form-control" id="editfrom" name="from" required>
                        </div>
                        <div class="mb-3">
                            <label for="editTo" class="form-label">To</label>
                            <input type="date" class="form-control" id="editTo" name="to" required>
                        </div>
                    </div>
                    <hr class="m-0">
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete/Action Confirmation Modal -->
    <div class="modal fade" id="actionModal" tabindex="-1" role="dialog" aria-labelledby="actionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <h5 class="modal-title justify-content-center" id="actionModalLabel">
                        <i class="iconoir-warning-circle-outline" style="font-size: 3rem; color: #f1416c;"></i>
                    </h5><br>
                    <h6 id="confirmationMessage">Are you sure?</h6>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmAction">OK</button>
                </div>
            </div>
        </div>
    </div>


    <%- include('../partials/scripts') %>

    <!-- Page Specific Scripts -->
    <script>
    document.addEventListener('DOMContentLoaded', function () {

        // 1. Handle Edit Modal
        const editModal = document.getElementById('editOfferModal');    
        editModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget.closest('.edit-Offer-link');
            
            const offer = {
                id: button.getAttribute('data-id'), 
                avatar: button.getAttribute('data-avatar'), 
                linked_with: button.getAttribute('data-linked_with'), 
                from: button.getAttribute('data-from'), 
                to: button.getAttribute('data-to') 
            };
            const modal = this; 
            modal.querySelector('#editOfferId').value = offer.id; 
            modal.querySelector('#editLink').value = offer.linked_with; 
            modal.querySelector('#editfrom').value = offer.from; 
            modal.querySelector('#editTo').value = offer.to; 
            
            // Set form action
            modal.querySelector('#editOfferForm').action = `/admin/offers/update/${offer.id}`; 
            
            // Update image preview
            const preview = modal.querySelector('#editOfferImagePreview'); 
            if (offer.avatar && offer.avatar !== 'null' && offer.avatar !== 'NULL') { 
                preview.src = offer.avatar; 
                preview.style.display = 'block'; 
            } else {
                preview.src = ''; 
                preview.style.display = 'none'; 
            }
        });

        // 2. Handle Action Confirmation Modal
        const actionModal = new bootstrap.Modal(document.getElementById('actionModal')); 
        const confirmActionBtn = document.getElementById('confirmAction'); 
        const confirmationMessage = document.getElementById('confirmationMessage'); 
        let actionUrl = ''; 
        let httpMethod = 'POST'; 
        document.querySelectorAll('.action-btn').forEach(button => { 
            button.addEventListener('click', function (e) { 
                e.preventDefault(); 
                const offerId = this.getAttribute('data-id'); 
                const action = this.getAttribute('data-action'); 

                if (action === 'delete') {
                    confirmationMessage.innerText = 'Are you sure to Delete this Offer?'; 
                    actionUrl = `/admin/offers/delete/${offerId}`; 
                    httpMethod = 'DELETE'; 
                } else if (action === 'inactive') {
                    confirmationMessage.innerText = 'Are you sure to Inactive this Offer?'; 
                    actionUrl = `/admin/offers/status/${offerId}`; 
                    httpMethod = 'PATCH'; // <-- SUDHARO 1 (POST nu PATCH karyu)
                } else if (action === 'active') {
                    confirmationMessage.innerText = 'Are you sure to Active this Offer?'; 
                    actionUrl = `/admin/offers/status/${offerId}`; 
                    httpMethod = 'PATCH'; // <-- SUDHARO 2 (POST nu PATCH karyu)
                }
                
                actionModal.show(); 
            });
        });

        // Handle the confirmation click
        confirmActionBtn.addEventListener('click', async function () { 
            if (actionUrl) {
                try {
                    const response = await fetch(actionUrl, {
                        method: httpMethod, 
                        headers: { 
                            'Content-Type': 'application/json', 
                            // <-- SUDHARO 3: Authentication token add karyu
                            'Authorization': 'Bearer ' + localStorage.getItem('authToken') 
                        }
                    });
                    if (response.ok) { 
                        actionModal.hide(); 
                        location.reload(); 
                    } else {
                        alert('Failed to perform action.'); 
                        actionModal.hide();
                    }
                } catch (error) {
                    alert('An error occurred.'); 
                    actionModal.hide();
                }
            }
        });

        // 3. Handle Form Submissions
        handleFormSubmit('addOfferForm');   
        handleFormSubmit('editOfferForm'); 

        function handleFormSubmit(formId) { 
            const form = document.getElementById(formId); 
            form.addEventListener('submit', async function(event) { 
                event.preventDefault(); 
                const submitButton = form.querySelector('button[type="submit"]'); 
                submitButton.disabled = true; 

                const formData = new FormData(form); 
                
                try {
                    const response = await fetch(form.action, {
                        method: 'POST', 
                        body: formData, 
                        // <-- SUDHARO 4: Form data (file upload) mate 'Authorization' header add karyu
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                        }
                    });

                    if (response.ok) { 
                        const modalId = form.closest('.modal').id; 
                        const modal = bootstrap.Modal.getInstance(document.getElementById(modalId)); 
                        modal.hide(); 
                        location.reload(); 
                    } else {
                        const errorData = await response.json(); 
                        alert(errorData.message || 'Failed to save offer.'); 
                    }
                } catch (error) {
                    alert('An error occurred.'); 
                } finally {
                    submitButton.disabled = false; 
                }
            });
        }
    });
</script>

</body>
</html>