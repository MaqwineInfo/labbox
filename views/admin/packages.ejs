<!DOCTYPE html>
<html lang="en" dir="ltr" data-startbar="dark" data-bs-theme="light">

<head>
    <%- include('../partials/head') %>
    <style>
        /* Tooltip style for long text */
        .short-desc {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <%- include('../partials/topbar') %>
    <%- include('../partials/sidebar') %>

    <div class="page-wrapper">
        <div class="page-content">
            <div class="container-fluid">

                <div class="row">
                    <div class="col-sm-12">
                        <div class="page-title-box d-md-flex justify-content-md-between align-items-center">
                            <h4 class="page-title">Package</h4>
                            <button type="button" class="btn btn-primary ms-2" data-bs-toggle="modal"
                                data-bs-target="#addPackageModal">
                                Add Package
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <% if (typeof error !=='undefined' && error) { %>
                            <div class="alert alert-danger"><%= error %></div>
                        <% } %>
                        <% if (typeof success !=='undefined' && success) { %>
                            <div class="alert alert-success"><%= success %></div>
                        <% } %>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Package List</h4>
                            </div>
                            <div class="card-body">

                                <div class="d-flex flex-wrap justify-content-between mb-3">
                                    <form class="d-flex" id="searchForm" action="/admin/packages" method="GET">
                                        <input class="form-control me-2" type="search"
                                            placeholder="Search by Package Name" name="name"
                                            value="<%= typeof query !== 'undefined' ? query.name : '' %>">
                                        <button class="btn btn-outline-primary" type="submit">Search</button>
                                        <a href="/admin/packages" class="btn btn-outline-secondary ms-2">Clear</a>
                                    </form>

                                    <div class="ms-auto">
                                        <div class="dropdown">
                                            <button class="btn btn-primary dropdown-toggle" type="button"
                                                id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                                Filter
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="filterDropdown">
                                                <li><a class="dropdown-item" href="/admin/packages?status=all">All</a></li>
                                                <li><a class="dropdown-item" href="/admin/packages?status=1">Active</a></li>
                                                <li><a class="dropdown-item" href="/admin/packages?status=0">Inactive</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="packagesTable">
                                        <thead>
                                            <tr>
                                                <th>Image</th>
                                                <th>Package Name</th>
                                                <th>Short Description</th>
                                                <th>Category</th>
                                                <th>MRP</th>
                                                <th>Status</th>
                                                <th>Action</th>
                                                <th>View</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% if (typeof packages !=='undefined' && packages.length> 0) { %>
                                                <% packages.forEach(pkg=> { %>
                                                    <tr>
                                                        <td>
                                                            <img src="<%= pkg.avatar || 'https://placehold.co/50x50/eee/31343c?text=Img' %>"
                                                                style="border-radius:50%" width="50px" height="50px" alt="<%= pkg.name %>">
                                                        </td>

                                                        <td class="short-desc" data-bs-toggle="tooltip" data-bs-placement="bottom" title="<%= pkg.name %>">
                                                            <%= pkg.name %>
                                                        </td>

                                                        <td class="short-desc" data-bs-toggle="tooltip" data-bs-placement="bottom" title="<%= pkg.short_desc %>">
                                                            <%= pkg.short_desc || 'N/A' %>
                                                        </td>

                                                        <td>
                                                            <%= pkg.categories_id && pkg.categories_id.length> 0
                                                                ? pkg.categories_id.map(c => c.name).join(', ')
                                                                : 'N/A' %>
                                                        </td>

                                                        <td><%= pkg.mrp %></td>

                                                        <td>
                                                            <% if (pkg.status==1) { %>
                                                                <span class="badge bg-success-subtle text-success">Active</span>
                                                            <% } else { %>
                                                                <span class="badge bg-danger-subtle text-danger">Inactive</span>
                                                            <% } %>
                                                        </td>

                                                        <td>
                                                            <div class="dropdown">
                                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                                                    type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                                    Action
                                                                </button>
                                                                <ul class="dropdown-menu">
                                                                    <li>
                                                                        <a class="dropdown-item edit-package-link" href="#"
                                                                           data-bs-toggle="modal"
                                                                           data-bs-target="#editPackageModal"
                                                                           data-id="<%= pkg._id %>"
                                                                           data-name="<%= pkg.name %>"
                                                                           data-category_id="<%= pkg.categories_id && pkg.categories_id.length > 0 ? pkg.categories_id[0]._id : '' %>"
                                                                           data-avatar="<%= pkg.avatar %>"
                                                                           data-mrp="<%= pkg.mrp %>"
                                                                           data-discount_price="<%= pkg.dis_price %>"
                                                                           data-discount_percentage="<%= (pkg.mrp && pkg.dis_price) ? Math.round(((pkg.mrp - pkg.dis_price) / pkg.mrp) * 100) : 0 %>"
                                                                           data-long_desc="<%= pkg.long_desc %>"
                                                                           data-short_desc="<%= pkg.short_desc %>"
                                                                           data-package_instruction="<%= pkg.package_instruction %>"
                                                                           data-for_what="<%= pkg.for_what %>"
                                                                           data-benefits="">
                                                                           Edit
                                                                        </a>
                                                                    </li>
                                                                    <li>
                                                                        <% if(pkg.status==1) { %>
                                                                            <a class="dropdown-item action-btn" href="#" data-id="<%= pkg._id %>" data-action="inactive">Inactive</a>
                                                                        <% } else { %>
                                                                            <a class="dropdown-item action-btn" href="#" data-id="<%= pkg._id %>" data-action="active">Active</a>
                                                                        <% } %>
                                                                    </li>
                                                                    <li><hr class="dropdown-divider"></li>
                                                                    <li>
                                                                        <a class="dropdown-item text-danger action-btn" href="#" data-id="<%= pkg._id %>" data-action="delete">Delete</a>
                                                                    </li>
                                                                </ul>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <a href="/admin/packages/view/<%= pkg._id %>" class="btn btn-lg bi bi-eye" data-bs-toggle="tooltip" title="View Details">
                                                                <i class="iconoir-eye"></i>
                                                            </a>
                                                        </td>
                                                    </tr>
                                                <% }); %>
                                            <% } else { %>
                                                <tr>
                                                    <td colspan="8" class="text-center">No packages found.</td>
                                                </tr>
                                            <% } %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div> </div>
    </div>

    <div class="modal fade" id="addPackageModal" tabindex="-1" aria-labelledby="addPackageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPackageModalLabel">Add Package</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <hr class="m-0">
                <form id="addPackageForm" method="POST" action="/admin/packages" enctype="multipart/form-data">
                    <div class="modal-body row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category_id" class="form-label">Category</label>
                                <select class="form-control" name="categories_id" id="category_id" required>
                                    <option value="" hidden>Select Category</option>
                                    <% if (typeof categories !=='undefined' && categories.length> 0) { %>
                                        <% categories.forEach(cat=> { %>
                                            <option value="<%= cat._id %>"><%= cat.name %></option>
                                        <% }); %>
                                    <% } %>
                                </select>
                                <span id="add-categories_idError" class="text-danger" style="display:none;"></span>
                            </div>
                            <div class="mb-3">
                                <label for="avatar" class="form-label">Package Image</label>
                                <input type="file" class="form-control" id="avatar" name="avatar" required>
                                <span id="add-avatarError" class="text-danger" style="display:none;"></span>
                            </div>
                            <div class="mb-3">
                                <label for="mrp" class="form-label">MRP</label>
                                <input type="number" class="form-control" id="mrp" name="mrp" placeholder="Enter MRP" required>
                                <span id="add-mrpError" class="text-danger" style="display:none;"></span>
                            </div>
                            <div class="mb-3">
                                <label for="discount_percentage" class="form-label">Discount in %</label>
                                <input type="number" class="form-control" id="discount_percentage" name="discount_percentage" placeholder="Enter Discount %" required>
                                <span id="add-discount_percentageError" class="text-danger" style="display:none;"></span>
                            </div>
                            <div class="mb-3">
                                <label for="short_desc" class="form-label">Short Description</label>
                                <textarea class="form-control" id="short_desc" name="short_desc" placeholder="Enter short description"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="package_instruction" class="form-label">Package Instruction</label>
                                <textarea class="form-control" id="package_instruction" name="package_instruction" placeholder="Enter package instruction"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">Package Name</label>
                                <input type="text" class="form-control" id="name" name="name" placeholder="Enter package name" required>
                                <span id="add-nameError" class="text-danger" style="display:none;"></span>
                            </div>
                            <div class="mb-3">
                                <label for="long_desc" class="form-label">Long Description</label>
                                <textarea class="form-control" id="long_desc" name="long_desc" placeholder="Enter long description"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="discount_price" class="form-label">Discount Price</label>
                                <input type="number" class="form-control" id="discount_price" name="dis_price" placeholder="Enter discount price" required>
                                <span id="add-dis_priceError" class="text-danger" style="display:none;"></span>
                            </div>
                            <div class="mb-3">
                                <label for="benefits" class="form-label">Benefits</label>
                                <textarea class="form-control" id="benefits" name="benefits" placeholder="Enter benefits"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="for_what" class="form-label">Who is it for?</label>
                                <textarea class="form-control" id="for_what" name="for_what" placeholder="Who is this package for?"></textarea>
                            </div>
                        </div>
                    </div>
                    <hr class="m-0">
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Package</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editPackageModal" tabindex="-1" aria-labelledby="editPackageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPackageModalLabel">Edit Package</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <hr class="m-0">
                <form id="editPackageForm" method="POST" enctype="multipart/form-data" data-method="PUT">
                    <input type="hidden" id="editPackageId" name="id">
                    <div class="modal-body row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_category_id" class="form-label">Category</label>
                                <select class="form-control" name="categories_id" id="edit_category_id" required>
                                    <option value="" hidden>Select Category</option>
                                    <% if (typeof categories !=='undefined' && categories.length> 0) { %>
                                        <% categories.forEach(cat=> { %>
                                            <option value="<%= cat._id %>"><%= cat.name %></option>
                                        <% }); %>
                                    <% } %>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="edit_avatar" class="form-label">Package Image</label>
                                <input type="file" class="form-control" id="edit_avatar" name="avatar">
                                <img id="editPackageImagePreview" src="" alt="Image" style="height: 100px; width: 100px; border-radius:50%; margin-top: 10px; display: none;">
                            </div>
                            <div class="mb-3">
                                <label for="edit_mrp" class="form-label">MRP</label>
                                <input type="number" class="form-control" id="edit_mrp" name="mrp" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit_discount_percentage" class="form-label">Discount in %</label>
                                <input type="number" class="form-control" id="edit_discount_percentage" name="discount_percentage" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit_short_desc" class="form-label">Short Description</label>
                                <textarea class="form-control" id="edit_short_desc" name="short_desc"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="edit_package_instruction" class="form-label">Package Instruction</label>
                                <textarea class="form-control" id="edit_package_instruction" name="package_instruction"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_name" class="form-label">Package Name</label>
                                <input type="text" class="form-control" id="edit_name" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit_long_desc" class="form-label">Long Description</label>
                                <textarea class="form-control" id="edit_long_desc" name="long_desc"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="edit_discount_price" class="form-label">Discount Price</label>
                                <input type="number" class="form-control" id="edit_discount_price" name="dis_price" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit_benefits" class="form-label">Benefits</label>
                                <textarea class="form-control" id="edit_benefits" name="benefits"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="edit_for_what" class="form-label">Who is it for?</label>
                                <textarea class="form-control" id="edit_for_what" name="for_what"></textarea>
                            </div>
                        </div>
                    </div>
                    <hr class="m-0">
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="actionModal" tabindex="-1" role="dialog" aria-labelledby="actionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <h5 class="modal-title justify-content-center" id="actionModalLabel">
                        <i class="iconoir-warning-circle-outline" style="font-size: 3rem; color: #f1416c;"></i>
                    </h5><br>
                    <h6 id="confirmationMessage">Are you sure?</h6>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmAction">OK</button>
                </div>
            </div>
        </div>
    </div>


    <%- include('../partials/scripts') %>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const authToken = 'Bearer ' + localStorage.getItem('authToken');

        //  Initialize Tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        //  Edit Modal
        const editModal = document.getElementById('editPackageModal');
        editModal.addEventListener('show.bs.modal', function (event) { 
            const button = event.relatedTarget;

            const pkg = {
                id: button.getAttribute('data-id'),
                name: button.getAttribute('data-name'),
                category_id: button.getAttribute('data-category_id'),
                avatar: button.getAttribute('data-avatar'),
                mrp: button.getAttribute('data-mrp'),
                discount_price: button.getAttribute('data-discount_price'),
                discount_percentage: button.getAttribute('data-discount_percentage'),
                long_desc: button.getAttribute('data-long_desc'),
                short_desc: button.getAttribute('data-short_desc'),
                package_instruction: button.getAttribute('data-package_instruction'),
                for_what: button.getAttribute('data-for_what'),
                benefits: button.getAttribute('data-benefits'),
            };

            const modal = this;
            modal.querySelector('#editPackageId').value = pkg.id;
            modal.querySelector('#edit_category_id').value = pkg.category_id;
            modal.querySelector('#edit_name').value = pkg.name;
            modal.querySelector('#edit_mrp').value = pkg.mrp;
            modal.querySelector('#edit_discount_price').value = pkg.discount_price;
            modal.querySelector('#edit_discount_percentage').value = pkg.discount_percentage;
            modal.querySelector('#edit_long_desc').value = pkg.long_desc;
            modal.querySelector('#edit_short_desc').value = pkg.short_desc;
            modal.querySelector('#edit_package_instruction').value = pkg.package_instruction;
            modal.querySelector('#edit_for_what').value = pkg.for_what;
            modal.querySelector('#edit_benefits').value = pkg.benefits;
             
            modal.querySelector('#editPackageForm').action = `/admin/packages/${pkg.id}`;

            const preview = modal.querySelector('#editPackageImagePreview');
            if (pkg.avatar && pkg.avatar !== 'null' && pkg.avatar !== 'NULL') {
                preview.src = pkg.avatar;
                preview.style.display = 'block';
            } else {
                preview.src = '';
                preview.style.display = 'none';
            }
        });

        //  Confirmation Modal
        const actionModal = new bootstrap.Modal(document.getElementById('actionModal'));
        const confirmActionBtn = document.getElementById('confirmAction');
        const confirmationMessage = document.getElementById('confirmationMessage');
        let actionUrl = '';
        let httpMethod = 'POST';

        document.querySelectorAll('.action-btn').forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                const pkgId = this.getAttribute('data-id');
                const action = this.getAttribute('data-action');

                if (action === 'delete') {
                    confirmationMessage.innerText = 'Are you sure you want to delete this package?';
                    actionUrl = `/admin/packages/${pkgId}`;
                    httpMethod = 'DELETE';
                } else if (action === 'inactive') {
                    confirmationMessage.innerText = 'Are you sure you want to set this package to Inactive?';
                    actionUrl = `/admin/packages/${pkgId}/toggle-status`;
                    httpMethod = 'PATCH';
                } else if (action === 'active') {
                    confirmationMessage.innerText = 'Are you sure you want to set this package to Active?';
                    actionUrl = `/admin/packages/${pkgId}/toggle-status`;
                    httpMethod = 'PATCH';
                }

                actionModal.show();
            });
        });

        confirmActionBtn.addEventListener('click', async function () {
            if (actionUrl) {
                try {
                    const response = await fetch(actionUrl, {
                        method: httpMethod,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': authToken
                        }
                    });

                    if (response.ok) {
                        actionModal.hide();
                        location.reload();
                    } else {
                        const errorData = await response.json();
                        alert(errorData.message || 'Failed to perform action.');
                        actionModal.hide();
                    }
                } catch (error) {
                    console.error('Action failed:', error);
                    alert('An error occurred.');
                    actionModal.hide();
                }
            }
        });

        // Submissions (Add/Edit)
        handleFormSubmit('addPackageForm');
        handleFormSubmit('editPackageForm');

        function handleFormSubmit(formId) {
            const form = document.getElementById(formId);
            
            form.addEventListener('submit', async function (event) {
                event.preventDefault();
                document.querySelectorAll('.text-danger').forEach(el => el.style.display = 'none');
                
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.disabled = true;

                const formData = new FormData(form);
                 
                const method = form.dataset.method || 'POST';

                try {
                    const response = await fetch(form.action, {
                        method: method,
                        body: formData,
                        headers: {
                            'Authorization': authToken
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json(); 
                        if (errorData.errors) {
                            for (const [key, message] of Object.entries(errorData.errors)) {
                                const errorElId = `add-${key}Error`;
                                const errorEl = document.getElementById(errorElId);
                                if (errorEl) {
                                    errorEl.textContent = message;
                                    errorEl.style.display = 'block';
                                }
                            }
                        } 
                        alert(errorData.message || 'An unknown error occurred.');
                    } else {
                        const modalId = form.closest('.modal').id;
                        const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
                        modal.hide();
                        location.reload();
                    }
                } catch (error) {
                    console.error('Form submission error:', error);
                    alert('An error occurred.');
                } finally {
                    submitButton.disabled = false;
                }
            });
        }
    });
    </script>
</body>
</html>